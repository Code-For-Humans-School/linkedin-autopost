extends layout

block content
  .container-fluid
    .container.custom-container
      .text-center
        h1= title

        if error == 'logoutError'
          .alert.alert-danger(role='alert') There was an error logging you out! Please try again!
        if error == 'setWebhookError'
          .alert.alert-danger(role='alert') There was an error setting webhooks for the selected repo! Please try again!
        if githubRepoError
          .alert.alert-danger(role='alert') #{githubRepoError}
        if userInfo && userInfo.length > 0
          p Welcome our GitHub guest: #{userInfo[0].github_username}
          //- Logout Button
          a.btn.btn-danger(href='/users/logout', style="margin-bottom: 20px;") Log Out

      //- Display GitHub Repositories
      if githubRepos && githubRepos.length > 0
        .row.no-gutters
          each repo in githubRepos
            .col-lg-4.col-md-6.col-sm-12.mb-4.custom-col
              .card.card-hover
                .card-body(data-repo-name=repo.name, webhook-repo-status=repo.hasSetWebhook, onclick=`showModal(event, ${currentPage}, ${perPage})`)
                  h5.card-title
                    span(style="color: #207fe0; font-weight: bolder; margin-right: 5px;")= repo.name
                    if repo.hasSetWebhook
                      i.bi.bi-check2-all(style="font-weight: bolder; font-size: 24px; color: green;")
                  p.card-text(style="color: #636c76;")= repo.description
                  .d-flex.align-items-center.flex-wrap
                    if repo.private
                      .badge.custom-badge(style="color: #636c76; font-weight: bold; border: 1px solid #d0d7de; border-radius: 10px;") Private
                    else
                      .badge.custom-badge(style="color: #636c76; font-weight: bold; border: 1px solid #d0d7de; border-radius: 10px;") Public
                    if repo.language
                      .badge.custom-badge(style="color: #776c76; display: flex; align-items: center; justify-content: center;")
                        span.circle(style="background-color: #f1df62; width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px;")
                        | #{repo.language}
                    if repo.stars > 0
                      .badge.custom-badge(style="color: #776c76; font-weight: bold; display: flex; align-items: center; justify-content: center;")
                        i.fas.fa-star(style="margin-right: 5px;")
                        | #{repo.stars}
                    if repo.forks > 0
                      .badge.custom-badge(style="color: #776c76; font-weight: bold; display: flex; align-items: center; justify-content: center")
                        i.fas.fa-code-branch(style="margin-right: 5px;")
                        | #{repo.forks}
      else
        .alert.alert-info(role='alert') No repositories found.

      //- Pagination Component
      .pagination-container
        .d-flex.flex-column.flex-sm-row.justify-content-between.align-items-end
          .form-group.mb-2.mb-sm-0
            label(for="perPageSelect", style="color: #636c76; font-weight: bolder; font-size: 16px; margin-bottom: 10px;") Repositories per page:
            select.form-control#perPageSelect(name="per_page", onchange="location = this.value;", style="box-shadow: none;")
              option(value=`/?page=1&per_page=15` selected=perPage==15) 15
              option(value=`/?page=1&per_page=30` selected=perPage==30) 30
              option(value=`/?page=1&per_page=50` selected=perPage==50) 50
          .pagination
            if currentPage > 1
              li.page-item
                a.page-link(href=`/?page=${currentPage-1}&per_page=${perPage}`, style="color: #207fe0; font-weight: bolder; margin-right: 5px; border-radius: 8px; box-shadow: none;") 
                  i.bi.bi-arrow-left.custom-icon
                  span.d-none.d-sm-inline(style="margin-left: 3px;") Previous
            else 
              //- Empty placeholder to maintain spacing
              li.page-item
              
                   
            if githubRepos.length == perPage
              li.page-item
                a.page-link(href=`/?page=${currentPage+1}&per_page=${perPage}`, style="color: #207fe0; font-weight: bolder; margin-left: 5px; border-radius: 8px; box-shadow: none;")
                  span.d-none.d-sm-inline(style="margin-right: 3px;") Next  
                  i.bi.bi-arrow-right.custom-icon
            else 
              //- Empty placeholder to maintain spacing
              li.page-item

      //- Modal for editing repository
      .modal#repoModal(tabindex="-1" role="dialog" style="display: none;")
        .modal-dialog(role="document")
          .modal-content
            .modal-header(style="padding: 10px 0px 10px 10px; border: none;")
              h6.modal-title(style="color: #212121; font-weight: bold;") Auto-Post Config
            .modal-body(style="padding: 0px 10px; font-size: 14px; border: none;")
              span#repoWebhookStatus(style="color: #808080;") Placeholder for webhook setup info: You haven't setup webhook for the repo
              span#repoNameModal(style="color: #207fe0; font-weight: bolder;") Placeholder for the repo name: sample-repo-name
              span#repoWebhookAction(style="color: #808080;") Placeholder for the repo action: Do you want to set it up now? 
            .modal-footer(style="display: flex; justify-content: flex-end; padding: 5px; border: none;")
              button.btn.btn-outline-secondary.btn-sm(type="button", data-dismiss="modal", style="border: none; font-weight: bolder;") Cancel
              button.btn.btn-outline-primary.btn-sm#repoActionButton(type="button", style="border: none;  font-weight: bolder;") Confirm
              

  //- Custom Styles
  style.
    .custom-badge:not(:first-child) {
      margin-left: 0px;
    }
    .card-hover {
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    .card-hover:hover {
      transform: scale(1.02);
    }
    .custom-col {
      padding-left: 10px;
      padding-right: 10px;
    }
    .custom-container {
      max-width: 1300px;
    }
    .container-fluid {
      padding-left: 30px;
      padding-right: 30px;
      padding-bottom: 60px;
    }
    @media (max-width: 576px) {
      .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
      }
      .pagination {
        width: 100%;
        justify-content: space-between;
      }
      .form-group {
        width: 100%;
      }
    }
    .custom-icon {
      font-size: 20px;
      font-weight: bolder;
      color: #207fe0;
    }

    .page-link {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal {
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      outline: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-dialog {
      margin: 20px;
      max-width: 450px;
    }
    .modal-content {
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 0.3rem;
      box-shadow: 0 3px 9px rgba(0, 0, 0, 0.5);
      outline: 0;
    }
    .modal-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      border-top-left-radius: 0.3rem;
      border-top-right-radius: 0.3rem;
    }
    .modal-body {
      position: relative;
      padding: 1rem;
      line-height: 20px;
    }
    .modal-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 1rem;
      border-top: 1px solid #dee2e6;
    }

  //- Custom Script
  script.
    function showModal(event, currentPage, perPage) {
      const repoName = event.currentTarget.getAttribute('data-repo-name');
      const hasSetWebhook = event.currentTarget.getAttribute('webhook-repo-status');
      const currentPage = currentPage || 1;
      const perPage = perPage || 15;

      if(hasSetWebhook != null) {
        document.getElementById('repoWebhookStatus').innerText = "You've already set up linkedin-auto-post for the repository ";
        document.getElementById('repoNameModal').innerText = repoName;
        document.getElementById('repoWebhookAction').innerText = ". Do you want to revoke it?";

        document.getElementById('repoActionButton').innerText = "Revoke"
        // Update the href attribute of the button
        document.getElementById('repoWebhookAction').href = `/webhook/config?repo=${repoName}&hassetwebhook=true&page=${currentPage}&per_page=${perPage}`;
        //- document.getElementById('repoActionButton').setAttribute('onclick', `handleRepoAction('${repoName}', true)`);

      } else {
        document.getElementById('repoWebhookStatus').innerText = "You haven't set up linkedin-auto-post for the repository ";
        document.getElementById('repoNameModal').innerText = repoName;
        document.getElementById('repoWebhookAction').innerText = ". Do you want to set it up now?";

        document.getElementById('repoActionButton').innerText = "Set Now"
        document.getElementById('repoWebhookAction').href = `/webhook/config?repo=${repoName}&hassetwebhook=false&page=${currentPage}&per_page=${perPage}`;
        //- document.getElementById('repoActionButton').setAttribute('onclick', `handleRepoAction('${repoName}', false)`);
      }
      //- document.getElementById('repoNameModal').innerText = repoName + " - Do you want to modify it?";
      const modal = document.getElementById('repoModal');
      modal.style.display = 'flex';
    }

    function handleRepoAction(repoName, hasSetWebhook) {
      fetch(`/webhook/config?repo=${repoName}&hassetwebhook=${hasSetWebhook}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            //- const repoCard = document.querySelector(`.card-body[data-repo-name="${repoName}"]`);
            //- const webhookIcon = repoCard.querySelector('.bi-check2-all');
            //- if (hasSetWebhook) {
            //-   if (webhookIcon) webhookIcon.remove();
            //- } else {
            //-   if (!webhookIcon) {
            //-     const icon = document.createElement('i');
            //-     icon.className = 'bi bi-check2-all';
            //-     icon.style = 'font-weight: bolder; font-size: 24px; color: green;';
            //-     repoCard.querySelector('h5.card-title').appendChild(icon);
            //-   }
            //- }
            //- repoCard.setAttribute('webhook-repo-status', data.hasSetWebhook);
            const page = parseInt(currentPage) || 1;
            const perpage = parseInt(perPage) || 15;
            window.location.href = `/?page=${page}&per_page=${perpage}`;
            document.getElementById('repoModal').style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('repoModal').style.display = 'none';
        });
    }

    window.onclick = function(event) {
      const modal = document.getElementById('repoModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    document.querySelectorAll('.modal .close, .modal .btn-outline-secondary').forEach(button => {
      button.onclick = function() {
        const modal = document.getElementById('repoModal');
        modal.style.display = 'none';
      }
    });
